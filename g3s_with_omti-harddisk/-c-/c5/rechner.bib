(*****************************************************************************)
(*    Bibliotheks-modul  RECHNER.BIB                                         *)
(*      Einfacher Taschenrechner mit %                                       *)
(*      Geht nur mit Fenstertechnik !!!                                      *)
(*****************************************************************************)

procedure TaschenRechner;

const RechenZeichen:
      set of char= ['+','-','*',':','/','%','=','v','V',#27,#13];
      AnfangsPunktX = 60; {Position f]r Rechner auf Monitor}
      AnfangsPunktY = 5;
var Zahl1, Zahl2 : real;
    RZ1, RZ2: char;

procedure HauptBild;
var Lauf:byte;
begin
  gotoxy(1,2);For Lauf:=1 to 14 do write('-'); writeln;
  writeln(' 7 8 9    / %'); writeln;
  writeln(' 4 5 6    * V'); writeln;
  writeln(' 1 2 3    -  '); writeln;
    write(' 0   .    + C')
end;

procedure SchreibZahl(Zahl : real);
  var ChZahl : string[9];
  begin
    str(Zahl:9:9,ChZahl);
    if pos('.',ChZahl)<>0
    then begin
           while copy(ChZahl, length(ChZahl),1)='0' do
           delete(ChZahl, length(ChZahl),1);
           if pos('.',ChZahl)=length(ChZahl)
           then delete(ChZahl,length(ChZahl),1)
         end;
    if (Zahl>999999999.0) or (Zahl<(-99999999.0))
    then begin write(^G); ChZahl:='E'+ChZahl end;
    gotoxy(2,1); writeln(ChZahl:11)
  end;

procedure LiesZahl(var Zahl : real; var RZ:char);
label exit;
var c     : char;
ZahlC     : string[9];
Code      : integer;
Punkt     : boolean;

begin
  ZahlC:=''; Zahl:=0; RZ:=' '; punkt:=false;
  repeat
    gotoxy(1,1); read(kbd,c); c:=upcase(c); if c=#13 then c:='=';
    case c of
      'V','v'  : rz:=c;
      '-'      : if length(ZahlC)=0 then ZahlC:=ZahlC+c else rz:=c;
      '.'      : if not punkt and (length(ZahlC)<9)
                 then begin ZahlC:=ZahlC+c; punkt:=true end;
      '0'..'9' : if length(ZahlC)<9 then ZahlC:=ZahlC+c else write(^G);
      ^H       : if length(ZahlC)=0 then rz:='C'
                 else Zahlc:=copy(Zahlc,1,length(ZahlC)-1);
    else rz:=c
    end;
    if rz='C' then goto exit;
    if Zahlc='' then write('0':12)
                else write(Zahlc:12);
    until rz in RechenZeichen;
    val(Zahlc,Zahl,Code);
exit:
end;

procedure RechenOperationen;
var Ergeb:real;
  begin
    Ergeb:=0; rz1:=' '; SchreibZahl(Ergeb);
    repeat
      LiesZahl(Zahl2,RZ2);
      gotoxy(1,1); write(RZ2);
      if RZ2='%' then begin
                        Zahl2:=(Ergeb*Zahl2/100);
                        gotoxy(1,1); SchreibZahl(Zahl2);
                        if RZ1<>'-' then RZ1:='+';
                        repeat read(kbd,RZ2); if RZ2=#13 then RZ2:='='
                        until RZ2 in RechenZeichen
                      end;
      if rz2='C'
      then Ergeb:=0
      else begin
             case rz1 of
               'V','v'   : Ergeb:=sqrt(Zahl2);
               ' '       : Ergeb:=Zahl2;
               '+', '='  : Ergeb:=(Ergeb+Zahl2);
               '-'       : Ergeb:=(Ergeb-Zahl2);
               '*'       : Ergeb:=(Ergeb*Zahl2);
               ':', '/'  : if zahl2<>0
                           then Ergeb:=(Ergeb/Zahl2)
                           else Ergeb:=1000000000.0
              end;
              rz1:=rz2
            end;
       SchreibZahl(Ergeb);
     until rz2=#27;
  end;

begin
 OpenWindow(AnfangsPunktX,AnfangsPunktY,AnfangsPunktX+15,AnfangsPunktY+11);
 HauptBild;
 RechenOperationen;
 CloseWindow
end;
