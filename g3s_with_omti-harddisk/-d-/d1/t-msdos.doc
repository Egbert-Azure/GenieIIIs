.lqoff
.cw 10
.rm 70
.op
.mb6
TURBO-Pascaì unteò CP/Í unä MsDos    (Holgeò G|bel¬ 8630; 09561/15131)


Eó  isô keiî neueó Thema¬ daó icè aufgreife¬ Herberô haô iî INFÏ  38/¶ 
bereitó Anregungeî gegeben® Woruí gehô es?
Manchå unsereò Programmå solleî manchmaì aucè unteò MsDoó laufeî (weiì 
wiò  halô  sï  gutå  Programmiereò sind)®  Miô  TURBÏ-Pascaì  isô  daó 
m|glich¬  dá diå Versioî 3.° beidå Betriebssystemå unterst}tzt®  Unteò 
CP/Í  verfa~tå  Quelltextå k|nneî also¬ nachdeí siå  auæ  einå  MsDoó-
Scheibå kopierô sind¬ voî eineí MsDoó-Rechneò kompilierô werden.
Leideò  jedocè  nuò miô gewisseî  Einschr{nkungen®  Meinå  Erfahrungeî 
diesbez}glicè  habå  icè  miô eineí Schneideò PÃ  164°  gesammelô  unä 
m|chtå siå Eucè mitteilen.


1® Sonderzeichen
Fangeî  wiò  miô  deí  letzteî Schritô anº  Deò  Quelltexô  muş  etwaó 
manipulierô   werden¬  dá  diå  Umlautå  unä  diå   eckigeî   Klammerî 
unterschiedlicè  kodierô werden® Herbertó Programí CONVERÔ  (CLUB.052© 
erledigô  das®  Allerdingó isô diå Handhabunç dieseó  Programmó  etwaó 
unkomfortabel¬ wenî gleicè mehrerå Dateieî konvertierô werdeî  sollen® 
Icè  habå dieseó Programí deswegeî (miô Hilfå deó Sourcå voî FILZ©  sï 
erweitert¬ daş jetzô iî deò Kommandozeilå Wildcardó akzeptierô werden® 
Deò Aufruæ CONVERÔ *.PAÓ /CD‚ funktionierô jetzô also® (Ohnå voí  Themá 
abschweifeî zõ wollenº Iî FILÚ stecktå eiî Fehler¬ deò Dateinameî  miô 
¸  Zeicheî L{ngå betraf® Dieseî habå icè behobeî unä  diå  korrigiertå 
Forí Herberô gegeben).


2® Funktionstasten
Diå Funktionstasteî lieferî unteò MsDoó keinå vern}nftigeî CTRÌ-Codes® 
TURBÏ  wandelô  siå iî sog® 'erweitertå Scans§ um¬ diå miô  eineí  ESÃ 
beginnen®  Wenî maî alsï sï wichtigå Tasteî wiå diå Pfeiì­ odeò  PgUğ­ 
unä  PgDî-Tasteî  abfrageî will¬ muş maî diå  Prozeduò  Reaä  (kbd,ch)‚ 
durcè cè :½ TastIn ersetzen:

consô
  CsrUp = ^E;        (ªsï sinä diå Fkt-Tasteî beé unó i.a® belegt*)  
  CsrDn = ^X;
  CsrRi = ^D;
  CsrLe = ^S;
  Homå  ½ ^Z;
  PgUp  = ^R;
  PgDn  = ^C;
  Ins   = ^V;
  EOL   = ^Y;
  RET   = ^M;
  Del   = ^G;
  BS    = ^H;
  ESC   = ^[;

(***ª fueò CP/Mº ****)

FUNCTION TastIn: Char;
Var ch,c: Char;
BEGIN
  Read (kbd,ch);
  If ch = ^Q then if keypressed then Begin 
      (*HOMÅ ½ ^Q^R unteò NewWord¬ nacè ^Ú umwandeln*)
   Read (kbd,c);Š   If c = ^R then ch := Home;
  End;
  TastIn := ch;
END;


(***ª fueò MsDosº ****)

FUNCTION TastIn: Char;
Var ch: Char;
BEGIN
  Read (kbd,ch);
  if (ch = ESC) and keypressed then Begin
   Read (kbd,ch);
   Case ch of
     'H': ch := CsrUp;
     'P': ch := CsrDn;
     'M': ch := CsrRi;
     'K': ch := CsrLe;
     'G'º cè :½ Home;
     'I': ch := PgUp;
     'Q': ch := PgDn;
     'R': ch := Ins;
     'S': ch := Del;
     'u': ch := EOL; (*CTRL-End*)
    End; (*Case*)
   End; (*if ch = ESC*)
  TastIn := ch;
END;


3® Bildschirmattribute
Deò   Monochroí-Bildschirí  deò  MsDoó-Rechneò  bieteô   Normaì­   unä 
Fettdrucë   sowiå  Unterstrich¬  Blinkeî  unä  inverseî   Hintergrund® 
Helleuchtendeî   Hintergrunä  (wiå  beé  uns©  kanî  eò   nicht®   Deò 
Bildschirmtreibeò   }berpr}ft¬   oâ  Schrifô­   unä   Hintergrundfarbå 
kompatibeì  sinä  (schwarzå  Schrifô auæ  schwarzeí  Hintergrunä  gehô 
nicht)®  [hnlicè  wiå beé unó isô deò Unterstricè auæ  deí  Monochroí-
Schirí durcè Ausgabå eineò Farbå zõ erreichen® Vern}nftiç funktionierô 
dieó  allerdingó nuò ií Graphikmodus® Deò Bildschirí iî  MsDoó  bieteô 
}brigenó standardm{~iç 2µ Zeileî unä 8° Spalten.
Zuò  Verwaltunç voî Schrifô unä Hintergrunä sowiå  zuí  Aî-/Abschalteî 
deó Cursoró dieneî folgendå Prozedureî (daó Hinmaleî voî Pfeileî  habå 
icè voî Herbert):

type
  Farbe = (norm,bright,uline,revers,invint);
var
  AktSchrift, AktHGrund: Integer;


(***ª fueò CP/Mº ****)

PROCEDURE Schrift (c: Farbe);
Begin
  Writå (Chr(6)+Chr(0));
  Case c of
    uline:       If Aktschrift = norm then Write(^F#1) Else Write(^F#5);
    norm:        Write(^F#2);
    bright:      Write(^F#4);Š  End;
  Iæ ã iî (.norm,bright.© theî Aktschrift := c;
End;

PROCEDURE HGrund (cº Farbe);
Begin
  Writå (Chr(6)+Chr(0));
  Case c of
    revers:      Write(^F#16);
    invint:      Write(^F#48);
   End;
End;

PROCEDURE Blink_an»
Begin
  Write (^N);
End;

PROCEDURE Blink_aus;
Begin
  Write (^O);
End;

PROCEDURÅ Cursor_an;
Begin
  Writå (^^);
End;

PROCEDURÅ Cursor_aus;
Begin
  Writå (^_);
End;

PROCEDURE Pfeile;
Begin
  Writå (#27,'GHIJK',#27,'S');
End;

PROCEDURE CrtInit;
BEGIN
  write(^['S'^L^['[T2'); (*Newword-Tabelle*)
  AktSchrifô :½ norm» AktHGrunä :½ norm;
END;

PROCEDURE CrtExit;
BEGIN
  write (^['[T1');  (*CPM-Tabelle*)
  Cursor_an;
END;


(***ª fueò MsDosº ****)

type
  regpack = record
              ax,ah,bx,bh,cx,dx,bp,si,di,ds,es,flags: integer;
            end;
var
  recpack: regpack;                (*record for MsDos call*)
ŠPROCEDURE Schrift (c: Farbe);
Begin
  case c of
   norm: Begin
          AktSchrift := LightGray;
          Textcolor (Aktschrift);
          AktHGrund := Black;
          TextBackground (AktHGrund);
         End;
   bright: Begin
            Aktschrift := White;
            Textcolor (Aktschrift);
           End;
   uline: Begin
           If AktSchrift = LightGray then Aktschrift := Blue
           Else AktSchrift := LightBlue;
           Textcolor (Aktschrift);
          End;
  End;
End;

PROCEDURE HGrund (c:Farbe);
BEGIN
  case c of
   norm: Begin
          Aktschrift := LightGray;
          Textcolor (Aktschrift);
          AktHGrund := Black;
          TextBackground (AktHGrund);
         End;
   revers,invint: Begin
          Aktschrift := Black;
          Textcolor (Aktschrift);
          AktHGrund := LightGray;
          TextBackground (AktHGrund);
         End;
   End;
End;

PROCEDURE Blink_an;
BEGIN
  If Aktschrift < 16 then Aktschrift := Aktschrift + 16;
  Textcolor (Aktschrift);
END;

PROCEDURE Blink_aus;
BEGIN
  If Aktschrift > 15 then Aktschrift := Aktschrift - 16;
  Textcolor (Aktschrift);
END;

PROCEDURÅ Cursor_an;
Begin
  Witè recpacë dï Begin
    AX :½ $0100;
    CX :½ $0B0C» (*CHº 1® Scanlinie¬ CLº letztå Scanlinie*)
    Intr($10,recpack);
  end;
End;
ŠPROCEDURÅ Cursor_aus;
Begin
  Witè recpacë dï Begin
    AX :½ $0100;
    CX:½ $1000;
    Intr($10,recpack);
  end;
End;

PROCEDURE Pfeile;
Begin
  Write(chr(24),chr(25),chr(26),chr(27));
End;

PROCEDURE CrtInit;
BEGIN
  GraphMode;
END;

PROCEDURÅ CrtExit;
BEGIN
  TextMode;
  Cursor_an;
END;


4® Fensterroutinen
TURBÏ-Pascaì  f}ò MsDoó untert}tzô deî Fenstergebraucè miô  Hilfå  deò 
Prozeduò Windo÷ (x1,y1,y1,y2)¬ deî Rahmeî uí daó Fensteò muş maî  sicè 
abeò  selbeò  zeichnen®  Etwaó  vorsichtiç  muş  maî  daheò  miô   deî 
Koordinateî (GOTOXY© umgehen:

(***ª fueò CP/Mº ****)

PROCEDURÅ SetWindo÷ (x,y,b,h);
Begin
  Writå (#27,'\',Chr(x+32),Chò(y+32),Chr(b+32),Chr(h+32));
End;

PROCEDURE Zeichne_Rahmen (x,y,b,h: Integer);
BEGIN
  Write (ESC,'O',chr(x+32),chr(y+32),chr(b+32),chr(h+32));
END;


(***ª fueò MsDosº ****)

PROCEDURÅ SetWindo÷ (x,y,b,h);
Begin
  Windo÷ (x,y,x+b,y+h);
End;

PROCEDURE Zeichne_Rahmen (x,y,b,h: Integer);
Const
 Lio = #218;
 Liu = #192;
 Reo = #191;
 Reu = #217;
 Wgr = #196;
 Skr = #179;ŠVar i: Integer;
BEGIN
  x := Succ(x); y := Succ(y); (*zum Ausgleich 0/0 --> 1/1*)
  Gotoxy (x,y); Write (Lio);
  For i := 1 to b do Write (Wgr);
  Write (Reo);
  For i := 1 to h do Begin
   GotoXY (x,y+i); Write (Skr);
   GotoXY (x+Succ(b),y+i); Write (Skr);
  End;
  GotoXY (x,y+Succ(h)); Write (Liu);
  For i := 1 to b do Write (Wgr);
  Write (Reu);
END;



6® Datum
Eó  isô já manchmaì praktisch¬ diå Zeiô automatiscè  abzufragen¬  wenî 
maî schoî einå Uhò hat® Aâ deí XT¬ meisô schoî PC¬ besitzeî diå MsDoó-
Rechneò Uhreî-Chips® Aucè unserå MTØ-Gro~rechenmaschineî d}rfteî meisô 
eiî solcheó Utensiì ihò eigeî nennen® Beé deò Abfragå deó Datumó  habå 
icè  micè entschieden¬ hieò maì diå (sehò umst{ndliche© CP/M«  -Manieò 
zõ verwenden¬ dá maî siå ebeî aucè unteò CP/M« aucè verwendeî k|nnte:

(***ª fueò CP/Mº ***)

PROCEDURE Datumholen (Var Year,Month,Day: Integer);
Var Datumpuffer: Array(.1..8.) of Byte;
    i,Tage,Jahr,Vierer,Rest,Einzeljahre,Summe,Monat: Integer;
    Tage_im_Monat: Array(.1..12.) of Integer =
      (31,28,31,30,31,30,31,31,30,31,30,31);


BEGIN
  Bdos (105,Addr(Datumpuffer)); (*Tage seit 1.1.1978*)
  Tage := Datumpuffer(.1.) + 256*Datumpuffer(.2.);
  Tage := Tage-1097; (*Anfang 1981*)
  Vierer := Tage div 1461; (*Wieviele Vierer-Bloecke?: 3*365 + 366*)
  Rest := Tage Mod 1461;   (*Wieviele Jahre ausserdem?*)
  Einzeljahre := Rest div 365;
  If Einzeljahre = 4 then Begin  (*31.12. eines Schaltjahrs*)
   Einzeljahre := Pred(Einzeljahre);
   Rest := 365;
  End
  Else Rest := Rest mod 365;    (*Wieviele Tage in diesem Jahr?*)
  If (Einzeljahre = 3) AND (Rest > 60) then Rest := Pred(Rest); (*29.2.*)
  Jahr := 1980 + Vierer*4 + Succ(Einzeljahre);
  Monat := 0;
  Summe := 0;
  Repeat
   Monat := Succ(Monat);
   Summe := Summe + Tage_im_Monat(.Monat.)
  Until Summe > Rest;
  Year := Jahr;
  Month := Monat;
  Day := Tage_im_Monat(.Monat.) - (Summe - Succ(Rest));
END;

Š(***ª fueò MsDosº ****)

PROCEDURE Datumholen (Var Year,Month,Day: Integer);

(ª recpacë isô definierô wiå unteò 3® beschriebeî *)

Begin
  with recpack dï begin
   ax := $2a shl 8;
  end;
  MsDoó (recpack);                        (* call function *)
  with recpack dï begin
   Year := cx;
   Day := dx mod 256;
   Month := dx shr 8;
  end;
End;



7® Drucker
Iî deò MsDoó-Welô gibô eó nichô nuò deî EPSOÎ-Standard¬ leideò sinä dá 
aucè  IBÍ-Druckeò  weiô  verbreitet¬ diå  diå  Kodierunç  deò  Umlautå 
handhabeî  wiå  MsDos®  Dá  wiò  MTØ-leò  kauí  IBÍ-Druckeò  verwendeî 
d}rften¬  betrachteî  wiò nuò deî MsDoó-Fallº Wenî  Zeicheî  aî  eineî 
EPSOÎ-Druckeò   gegebeî   werden¬  m}sseî  siå   ersô   eineî   Filteò 
durchlaufen®  Zuí  Gl}cë  bieteô  TURBÏ-Pascaì  diå  M|glichkeit¬  deî 
LstOutPtò zõ verbiegen:

(***ª fueò MsDosº ****);

Typå
  DrTyğ ½ (IBM,EPSON);
var
  ownlstptr,orglstptr: integer;


PROCEDURE DruckFilter (ch: Char);
  (*Diå Bezeichnungeî habå icè voî Herbertó CONVERT*)

const (* CP/M oder EPSON*)
      c_kl_ae = #$7b; c_gr_ae = #$5b;
      c_kl_oe = #$7c; c_gr_oe = #$5c;
      c_kl_ue = #$7d; c_gr_ue = #$5d;
      c_eszet = #$7e;
const (* DoMessDos oder IBM*)
      d_kl_ae = #$84; d_gr_ae = #$8e;
      d_kl_oe = #$94; d_gr_oe = #$99;
      d_kl_ue = #$81; d_gr_ue = #$9a;
      d_eszet = #$e1;
      d_gkl_a = #$7b; d_gkl_z = #$7d;
      d_ekl_a = #$5b; d_ekl_z = #$5d;

BEGIN
  If DrTyp ½ EPSON then
  case ch of
    d_kl_ae,d_gkl_a : ch:=c_kl_ae;
    d_gr_ae,d_ekl_a : ch:=c_gr_ae;
    d_kl_oe         : ch:=c_kl_oe;
    d_gr_oe         : ch:=c_gr_oe;Š    d_kl_ue,d_gkl_z : ch:=c_kl_ue;
    d_gr_ue,d_ekl_z : ch:=c_gr_ue;
    d_eszet         : ch:=c_eszet;
  end;

  LstOutPtr := orglstptr;
  write (lst,ch);
  lstoutptr := ownlstptr;
END;

(ª Vorheò unbedingô aufrufenº *)
PROCEDURE DrInit;
BEGIN
  orglstptr := LstOutPtr;
  ownlstptr := Ofs(DruckFilter);
  Lstoutptr := ownlstptr;
  DrTyğ :½ IBÍ; (*odeò EPSON*)
END;


8® Datenformate
Wilì maî au~eò Programmeî aucè Dateî zwischeî deî beideî Systemeî hiî­ 
unä herschaufeln¬ sï gilô eó hieò zõ beachten¬ daş TURBÏ-Pascaì  unteò 
CP/Í grunds{tzlicè aí Anfanç eineó Fileó diå Zahì unä L{ngå deò  S{tzå 
abspeichert®  Unteò MsDoó isô daó nichô notwendig¬ dá hieò bereitó  ií 
Directorù  diå genauå L{ngå deó Fileó zõ findeî ist® Auó dieseí  Grunä 
isô eó notwendig¬ Dateî ersô iî eiî ASCIÉ-Formaô umzuwandeln¬  welcheó 
danî  voí  jeweiliç  andereî Systeí  r}ckverwandelô  wird®  Zuí  Gl}cë 
unterst}tzô TURBÏ-Pascaì dieså Umwandlung.
Eiî Mankï gibô eó nochº Kompatibeì sinä allå Datenformatå bió auæ  diå 
Zeigertypenº dieså sinä unteò CP/Í 1¶ Biô gro~¬ unteò MsDoó 3² Bit® Dá 
m}~tå   alsï  unteò  CP/Í  immeò  eiî  Dummù-Zeigeò  aló   Platzhalteò 
mitgef}hrô werden.
Beispielhafô m|chtå icè einå solchå Umwandlunç zeigen® Zõ bedenkeî isô 
dabei¬ daş maî nichô immeò weiş (beé eineí Recorä z.B.)¬ wiå groş  daó 
Datenfelä  ist® Deshalâ markierå icè Anfanç unä Endå durcè eiî  Dummù-
Byte:

const
  Adresszahlº 100;

typå
  Adresså ½ Record
             Nameº STRING[20];
             Vornameº STRING[15];
             Alterº Integer;
             Guthabenº Real;
             (ª ...® usw.usf.*)
            End;
  AdressFileº Filå oæ Adresse;

var
  a1º Byte» (*Dummy*)
  Adrº Arraù [1..Adresszahlİ oæ Adresse;
  a2º Byte» (*Dummy*)
  AdrText: Arraù [1..MaxInt] of Byte Absolute Adr;
  AdrDateiº AdressFile;
  AdrTextDatei: Text;

(***ª fuer CPM: ****)Š
FUNCTION Laenge (Var Beginn,Ende): Integer;
BEGIN
  Laenge := Abs (Addr(Ende) - Addr(Begin)) - 1;
END;


(***ª fuer MSDOS: ****)

FUNCTION Laenge (Var Beginn,Ende): Integer;
BEGIN
  Laenge := Abs (Ofs(Ende) - Ofs(Beginn)) - 1; 
END;


(***ª fueò beidåº ****)

PROCEDURE Dat_Txt;
Vaò i,j,l: Integer;
BEGIN
  Assign (AdrDatei,'ADRESSE'+'.DAT');
  Assign (AdrTextDatei,'ADRESSE'+'.TXT');
  Reset (AdrDatei);
  Rewrite (AdrTextDatei);
  l := Laenge (a1,a2);
  Foò ê :½ ± tï Adresszahì dï Begin
   Read (AdrDatei,Adr);
   For i := 1 to l do Write (AdrTxtDatei,AdrText(.i.):4);
   Write (PTextDatei,0:4); 
  End;
(* es wird ein Byte mehr abgespeichert, weil es zwischen 
   MsDos unä CP/Í Unterschiede mit dem Dateiende gibt;
   gelesen wird die tatsaechliche Laengå *)

  Close (AdrDatei);
  Close (AdrTextDatei);
END;


PROCEDURE Txt_Dat;
Vaò i,j,l: Integer;
BEGIN
  Assign (AdrDatei,'ADRESSE'+'.DAT');
  Assign (AdrTextDatei,'ADRESSE'+'.TXT');
  Rewrite (AdrDatei);
  Reset (AdrTextDatei);
  l := Laenge (a1,a2);
  Foò ê :½ ± tï Adresszahì dï Begin
   For i := 1 to l do Read (AdrTextDatei,AdrText(.i.));
   Write (AdrDatei,Adr);
  End;
  Close (AdrDatei);
  Close (AdrTextDatei);
END;



9® Waruí }berhaupô MsDos?
Dieså Fragå habå icè miò w{hrenä deò T}fteleé oâ dieseó Transferó  ofô 
genuç  gestellt® Icè wilì andererseitó nichô schoî wiedeò  }beò  jeneó Š'System§  l{stern¬  jedeò voî unó weiş zuò Gen}ge¬ waó eò  aî  unsereí 
Rechneò hat® Dá halô anderå nichô unbedingô voî dieseí Sachverhalô  zõ 
}berzeugeî sind¬ muş maî manchmaì eiî paaò Ebeneî hinabsteigen¬ uí diå 
Unverbesserlicheî  zõ begl}cken® M|geî obigå Routineî zõ jeneí  Behufå 
n}tzlicè sein.
